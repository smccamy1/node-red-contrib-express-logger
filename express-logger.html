<script type="text/javascript">
    RED.nodes.registerType('express-logger', {
        category: 'network',
        color: '#a6bbcf',
        defaults: {
            name: { value: "" },
            logLevel: { value: "combined" },
            includeHeaders: { value: false },
            includeBody: { value: false },
            maxBodySize: { value: 1024, validate: RED.validators.number() },
            filterPaths: { value: "" },
            outputToFlow: { value: false },
            enableCsvExport: { value: false },
            csvLogFile: { value: "" },
            maxCsvFileSize: { value: 50, validate: RED.validators.number() },
            maxRotatedCsvFiles: { value: 10, validate: RED.validators.number() }
        },
        inputs: 0,
        outputs: 1,
        icon: "white-globe.png",
        label: function() {
            return this.name || "Express Logger";
        },
        labelStyle: function() {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function() {
            const node = this;
            
            // Toggle CSV export options visibility
            function toggleCsvExportOptions() {
                const enableCsv = $("#node-input-enableCsvExport").is(':checked');
                if (enableCsv) {
                    $("#csv-export-options").show();
                } else {
                    $("#csv-export-options").hide();
                }
            }
            
            // Set up event handlers
            $("#node-input-enableCsvExport").change(toggleCsvExportOptions);
            
            // Initial state
            toggleCsvExportOptions();
            
            // Initialize download button state
            $("#download-csv-btn").hide();
            
            // CSV Export button handler
            $("#export-csv-btn").click(function() {
                const button = $(this);
                const downloadBtn = $("#download-csv-btn");
                
                button.prop('disabled', true);
                button.html('<i class="fa fa-spinner fa-spin"></i> Exporting...');
                
                // Send request to node to export CSV
                $.ajax({
                    url: "express-logger/" + node.id + "/export-csv",
                    type: "POST",
                    success: function(data) {
                        button.prop('disabled', false);
                        button.html('<i class="fa fa-download"></i> Export Current Logs to CSV');
                        if (data.success) {
                            RED.notify("CSV ready for download (" + data.recordCount + " entries)", "success");
                            console.log("CSV file ready:", data);
                            
                            // Enable and show download button
                            downloadBtn.show();
                            downloadBtn.prop('disabled', false);
                            downloadBtn.data('filename', data.fileName);
                            downloadBtn.find('.download-info').text(`${data.recordCount} entries (${Math.round(data.fileSize/1024)}KB)`);
                        } else {
                            RED.notify("Export failed: " + (data.error || "Unknown error"), "error");
                            downloadBtn.hide();
                        }
                    },
                    error: function() {
                        button.prop('disabled', false);
                        button.html('<i class="fa fa-download"></i> Export Current Logs to CSV');
                        RED.notify("Export request failed", "error");
                        downloadBtn.hide();
                    }
                });
            });

            // CSV Download button handler - Simplified for direct CSV file download
            $("#download-csv-btn").click(function() {
                const button = $(this);
                let downloadAttempted = false;
                
                console.log("Starting CSV download");
                
                // Method 1: Try direct iframe download (works with auth)
                const authUrl = "express-logger/" + node.id + "/download-csv";
                console.log("Trying authenticated download:", authUrl);
                
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.src = authUrl;
                document.body.appendChild(iframe);
                
                // Clean up iframe after download
                setTimeout(function() {
                    if (iframe.parentNode) {
                        document.body.removeChild(iframe);
                    }
                }, 3000);
                
                // Method 2: Fallback to public endpoint only if iframe hasn't worked
                setTimeout(function() {
                    // Check if the iframe approach might have failed by testing the auth endpoint
                    if (!downloadAttempted) {
                        fetch(authUrl, { method: 'HEAD' })
                            .then(response => {
                                if (!response.ok) {
                                    // Auth failed, try public endpoint
                                    console.log("Auth endpoint failed, attempting public endpoint fallback");
                                    attemptPublicDownload();
                                } else {
                                    console.log("Auth endpoint accessible, assuming download worked");
                                }
                            })
                            .catch(() => {
                                // Network error or auth failed, try public endpoint
                                console.log("Auth endpoint unreachable, attempting public endpoint fallback");
                                attemptPublicDownload();
                            });
                    }
                }, 1500);
                
                function attemptPublicDownload() {
                    if (downloadAttempted) return; // Prevent multiple attempts
                    downloadAttempted = true;
                    
                    const baseUrl = window.location.origin;
                    const httpRoot = RED.settings.httpNodeRoot || "";
                    
                    // Construct URL carefully to avoid double slashes
                    let publicUrl = baseUrl;
                    if (httpRoot && !httpRoot.startsWith('/')) {
                        publicUrl += '/';
                    }
                    publicUrl += httpRoot;
                    if (!publicUrl.endsWith('/')) {
                        publicUrl += '/';
                    }
                    publicUrl += "express-logger-download/" + node.id;
                    
                    console.log("Public download URL:", publicUrl);
                    
                    // Try opening in new window/tab
                    const newWindow = window.open(publicUrl, '_blank');
                    
                    // If popup blocked, create download link
                    if (!newWindow || newWindow.closed || typeof newWindow.closed == 'undefined') {
                        console.log("Popup blocked, using direct link");
                        const link = document.createElement('a');
                        link.href = publicUrl;
                        link.download = 'express-logger.csv';
                        link.target = '_blank';
                        link.style.display = 'none';
                        document.body.appendChild(link);
                        link.click();
                        setTimeout(function() {
                            if (link.parentNode) {
                                document.body.removeChild(link);
                            }
                        }, 100);
                    }
                }
                
                RED.notify("Download started", "success");
            });
        }
    });
</script>

<script type="text/html" data-template-name="express-logger">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Express Logger">
    </div>
    
    <div class="form-row">
        <label for="node-input-logLevel"><i class="fa fa-list"></i> Log Format</label>
        <select id="node-input-logLevel">
            <option value="combined">Combined (Apache combined log format)</option>
            <option value="common">Common (Apache common log format)</option>
            <option value="dev">Dev (Concise colored output for development)</option>
            <option value="short">Short</option>
            <option value="tiny">Tiny</option>
            <option value="custom">Custom (Detailed Node-RED format)</option>
        </select>
    </div>
    
    <div class="form-row">
        <label for="node-input-includeHeaders"><i class="fa fa-header"></i> Include Headers</label>
        <input type="checkbox" id="node-input-includeHeaders" style="display: inline-block; width: auto; vertical-align: top;">
    </div>
    
    <div class="form-row">
        <label for="node-input-includeBody"><i class="fa fa-file-text-o"></i> Include Request Body</label>
        <input type="checkbox" id="node-input-includeBody" style="display: inline-block; width: auto; vertical-align: top;">
    </div>
    
    <div class="form-row">
        <label for="node-input-maxBodySize"><i class="fa fa-database"></i> Max Body Size (bytes)</label>
        <input type="number" id="node-input-maxBodySize" placeholder="1024">
    </div>
    
    <div class="form-row">
        <label for="node-input-filterPaths"><i class="fa fa-filter"></i> Filter Paths</label>
        <input type="text" id="node-input-filterPaths" placeholder="e.g., /debug,/settings (comma-separated)">
    </div>
    
    <div class="form-row">
        <label for="node-input-outputToFlow"><i class="fa fa-arrow-right"></i> Output to Flow</label>
        <input type="checkbox" id="node-input-outputToFlow" style="display: inline-block; width: auto; vertical-align: top;">
        <div class="form-tips" style="margin-left: 20px; margin-top: 5px; color: #666; font-style: italic;">
            Enable this to send log data to the output. Connect a debug node to see the log messages.
        </div>
    </div>
    
    <hr style="margin: 15px 0;">
    <h4 style="margin-bottom: 10px; color: #666;">CSV Export</h4>
    
    <div class="form-row">
        <label for="node-input-enableCsvExport"><i class="fa fa-table"></i> Enable CSV Export</label>
        <input type="checkbox" id="node-input-enableCsvExport" style="display:inline-block; width:auto; vertical-align:top;">
    </div>
    
    <div class="form-row" id="csv-export-options" style="margin-left: 20px;">
        <div class="form-row">
            <label for="node-input-csvLogFile" style="width: 120px;"><i class="fa fa-file-text-o"></i> CSV Log File</label>
            <input type="text" id="node-input-csvLogFile" placeholder="logs/express-logger.csv" style="width: 300px;">
            <div style="font-size: 11px; color: #666; margin-top: 5px;">File path for direct CSV logging (default: {userDir}/logs/express-logger.csv)</div>
        </div>
        
        <div class="form-row">
            <label for="node-input-maxCsvFileSize" style="width: 120px;"><i class="fa fa-archive"></i> Max File Size (MB)</label>
            <input type="number" id="node-input-maxCsvFileSize" placeholder="50" style="width: 100px;" min="1" max="1000">
            <div style="font-size: 11px; color: #666; margin-top: 5px;">Maximum CSV file size before rotation (default: 50MB)</div>
        </div>
        
        <div class="form-row">
            <label for="node-input-maxRotatedCsvFiles" style="width: 120px;"><i class="fa fa-files-o"></i> Max Rotated Files</label>
            <input type="number" id="node-input-maxRotatedCsvFiles" placeholder="10" min="0" max="100" style="width: 100px;">
            <div style="font-size: 11px; color: #666; margin-top: 5px;">Maximum number of old CSV files to keep (0 = unlimited)</div>
        </div>
        
        <div class="form-row">
            <button type="button" id="export-csv-btn" class="red-ui-button" style="margin-top: 10px;">
                <i class="fa fa-refresh"></i> Check CSV Status
            </button>
            <div style="font-size: 11px; color: #666; margin-top: 5px;">Check current CSV file status and prepare for download</div>
        </div>

        <div class="form-row">
            <button type="button" id="download-csv-btn" class="red-ui-button" style="margin-top: 10px; display: none;">
                <i class="fa fa-cloud-download"></i> Download CSV: <span class="download-info"></span>
            </button>
            <div style="font-size: 11px; color: #666; margin-top: 5px;">Download the current CSV log file</div>
        </div>
    </div>
</script>

<script type="text/html" data-help-name="express-logger">
    <p>A node that provides detailed logging of the Express web server used by Node-RED's editor UI, with enhanced monitoring for debugging automatic refreshes.</p>
    
    <h3>Refresh Monitoring Features</h3>
    <p>This node includes specialized monitoring to help debug automatic browser refreshes:</p>
    <ul>
        <li><strong>Editor Request Detection</strong> - Identifies requests to Node-RED editor vs static assets</li>
        <li><strong>Dashboard Request Monitoring</strong> - Tracks dashboard-specific traffic</li>
        <li><strong>Cache Control Analysis</strong> - Detects forced refresh headers (no-cache, pragma)</li>
        <li><strong>Connection Monitoring</strong> - Logs connection drops and timeouts</li>
        <li><strong>Server Event Tracking</strong> - Monitors server close/error events</li>
        <li><strong>Node-RED Runtime Events</strong> - Tracks flows start/stop, node additions/removals</li>
        <li><strong>Memory Usage Alerts</strong> - Warns about high memory usage that might cause issues</li>
        <li><strong>WebSocket Monitoring</strong> - Tracks Socket.IO events that might trigger refreshes</li>
        <li><strong>Authentication Failures</strong> - Logs auth errors that could cause redirects</li>
        <li><strong>Slow Response Detection</strong> - Identifies timeouts that might trigger refreshes</li>
    </ul>
    
    <h3>Configuration</h3>
    <dl class="message-properties">
        <dt>Log Format <span class="property-type">string</span></dt>
        <dd>The format for logging HTTP requests. Choose from standard formats or custom detailed logging.</dd>
        
        <dt>Include Headers <span class="property-type">boolean</span></dt>
        <dd>Whether to include HTTP headers in the log output.</dd>
        
        <dt>Include Request Body <span class="property-type">boolean</span></dt>
        <dd>Whether to include the request body in the log output (useful for POST/PUT requests).</dd>
        
        <dt>Max Body Size <span class="property-type">number</span></dt>
        <dd>Maximum size in bytes of the request body to log (prevents large payloads from flooding logs).</dd>
        
        <dt>Filter Paths <span class="property-type">string</span></dt>
        <dd>Comma-separated list of URL paths to exclude from logging (e.g., static assets, health checks).</dd>
        
        <dt>Output to Debug Panel <span class="property-type">boolean</span></dt>
        <dd>Send log messages to the Node-RED debug panel.</dd>
        
        <dt>Output to Flow <span class="property-type">boolean</span></dt>
        <dd>Send log data as messages to the node's output for further processing.</dd>
        
        <dt>Save to File <span class="property-type">boolean</span></dt>
        <dd>Whether to save log messages to a file on disk for persistent storage.</dd>
        
        <dt>Log File Path <span class="property-type">string</span></dt>
        <dd>Path to the log file. Default: {userDir}/logs/express-logger.log. Directory will be created if it doesn't exist.</dd>
        
        <dt>Max File Size (MB) <span class="property-type">number</span></dt>
        <dd>Maximum size of the log file in megabytes before rotation. Default: 10 MB.</dd>
        
        <dt>Log Rotation <span class="property-type">boolean</span></dt>
        <dd>Whether to enable automatic log file rotation when max size is reached. Rotated files are timestamped.</dd>
        
        <dt>Enable CSV Export <span class="property-type">boolean</span></dt>
        <dd>Whether to enable direct CSV file logging for data analysis.</dd>
        
        <dt>CSV Log File <span class="property-type">string</span></dt>
        <dd>File path for direct CSV logging. Default: {userDir}/logs/express-logger.csv. Each log entry is immediately written to this file.</dd>
        
        <dt>Max File Size (MB) <span class="property-type">number</span></dt>
        <dd>Maximum size of the CSV file in megabytes before rotation. Default: 50 MB. When exceeded, the file is rotated with a timestamp.</dd>
    </dl>
    
    <h3>File Logging Features</h3>
    <p>When file logging is enabled, the node provides persistent storage of HTTP request logs:</p>
    <ul>
        <li><strong>Automatic Directory Creation</strong> - Log directories are created automatically if they don't exist</li>
        <li><strong>Log Rotation</strong> - Files are automatically rotated when they exceed the configured size limit</li>
        <li><strong>Timestamped Rotation</strong> - Rotated files include timestamps for easy identification</li>
        <li><strong>Error Handling</strong> - File write errors are logged to the Node-RED console</li>
    </ul>
    
    <h3>CSV Export Features</h3>
    <p>The CSV export functionality provides direct file logging for easy data analysis:</p>
    <ul>
        <li><strong>Direct File Logging</strong> - Each log entry is immediately written to a CSV file</li>
        <li><strong>Persistent Storage</strong> - All data is automatically preserved across Node-RED restarts</li>
        <li><strong>Automatic Rotation</strong> - Files are rotated when they exceed the configured size limit</li>
        <li><strong>Real-time Export</strong> - No need to export - data is continuously saved</li>
        <li><strong>Simple Download</strong> - One-click download of the current CSV file</li>
        <li><strong>Proper Escaping</strong> - Handles commas, quotes, and newlines in data fields</li>
        <li><strong>Memory Efficient</strong> - No in-memory storage limits, all data goes directly to disk</li>
        <li><strong>Timestamped Files</strong> - Export files include timestamps in filename</li>
    </ul>
    </dl>
    
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">object</span></dt>
        <dd>When "Output to Flow" is enabled, outputs an object containing:
            <ul>
                <li><code>method</code> - HTTP method (GET, POST, etc.)</li>
                <li><code>url</code> - Request URL</li>
                <li><code>statusCode</code> - HTTP response status code</li>
                <li><code>responseTime</code> - Response time in milliseconds</li>
                <li><code>userAgent</code> - User agent string</li>
                <li><code>ip</code> - Client IP address</li>
                <li><code>headers</code> - Request headers (if enabled)</li>
                <li><code>body</code> - Request body (if enabled)</li>
                <li><code>timestamp</code> - ISO timestamp of the request</li>
                <li><code>isEditorRequest</code> - Boolean indicating if this is a Node-RED editor request</li>
                <li><code>isDashboardRequest</code> - Boolean indicating if this is a dashboard request</li>
                <li><code>hasRefreshIndicators</code> - Boolean indicating potential refresh triggers</li>
                <li><code>connectionIssues</code> - String describing any connection-related issues</li>
            </ul>
        </dd>
    </dl>
    
    <h3>Details</h3>
    <p>This node intercepts and logs all HTTP requests made to the Node-RED Express server, including:</p>
    <ul>
        <li>Editor UI requests</li>
        <li>API calls to Node-RED runtime</li>
        <li>Static file requests</li>
        <li>WebSocket upgrade requests</li>
        <li>Custom HTTP nodes endpoints</li>
    </ul>
    
    <p>The logging is implemented using middleware that captures request/response data without interfering with normal Node-RED operation.</p>
    
    <p><strong>Note:</strong> This node must be deployed to start logging. Only one instance should be used per Node-RED instance to avoid duplicate logs.</p>
</script>